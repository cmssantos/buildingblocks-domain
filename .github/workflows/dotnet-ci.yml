name: .NET CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches:
      - main
      - develop
      - 'feature/*'
      - 'hotfix/*'

permissions:
  contents: read
  pull-requests: write

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

  COVERLET_MIN_THRESHOLD: 85
  COVERLET_EXCLUDE: '[*.Tests]*,[*]Program'
  COVERLET_EXCLUDE_BY_FILE: '**/Migrations/*'
  COVERAGE_RESULT_FILE: '**/TestResults/**/coverage.cobertura.xml'

  SONAR_PROJECT_KEY: cleudice_myproject
  SONAR_ORGANIZATION: cleudice

jobs:

  # ------------------------------------------------------------------
  # 1️⃣ PR Hygiene — title + formatting
  # ------------------------------------------------------------------
  pr-quality:
    name: PR Quality Gate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Validate branch name
        run: |
          BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"

          if [[ ! "$BRANCH" =~ ^(main|develop|(feature|bugfix|hotfix)/[a-z0-9]+(-[a-z0-9]+)*|release/[0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "❌ Invalid branch name: $BRANCH"
            exit 1
          fi

      - name: Validate PR title (Conventional Commits)
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          requireScope: false
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert

      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore
        run: dotnet restore

      - name: Verify formatting
        run: dotnet format --verify-no-changes --no-restore

  # ------------------------------------------------------------------
  # 2️⃣ Build + Test + Coverage
  # ------------------------------------------------------------------
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: pr-quality
    strategy:
      fail-fast: false
      matrix:
        dotnet-version: [ '8.0.x', '10.0.x' ]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Test with coverage (enforced)
        run: |
          dotnet test \
            --configuration Release \
            --no-build \
            /p:CollectCoverage=true \
            /p:CoverletOutput=TestResults/ \
            /p:CoverletOutputFormat=cobertura \
            /p:Threshold=${{ env.COVERLET_MIN_THRESHOLD }} \
            /p:ThresholdType=line \
            /p:Exclude="${{ env.COVERLET_EXCLUDE }}" \
            /p:ExcludeByFile="${{ env.COVERLET_EXCLUDE_BY_FILE }}"

      # ----------------------------------------------------------------
      # 3️⃣ Coverage report + PR comment (primary version only)
      # ----------------------------------------------------------------
      - name: Coverage summary
        if: matrix.dotnet-version == '10.0.x'
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: ${{ env.COVERAGE_RESULT_FILE }}
          format: markdown
          badge: true
          output: both
          hide_complexity: true
          indicators: true
          thresholds: '85 95'
          fail_below_min: false

      - name: Comment coverage on PR
        if: matrix.dotnet-version == '10.0.x' && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: code-coverage-results.md

      - name: Upload coverage artifact
        if: matrix.dotnet-version == '10.0.x'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ env.COVERAGE_RESULT_FILE }}
          if-no-files-found: ignore

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: |
            ${{ runner.os }}-sonar

      - name: Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Add dotnet tools to PATH
        run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: SonarCloud Begin
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner begin \
            /k:"${{ env.SONAR_PROJECT_KEY }}" \
            /o:"${{ env.SONAR_ORGANIZATION }}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.login="${SONAR_TOKEN}" \
            /d:sonar.cs.cobertura.reportsPaths="${{ env.COVERAGE_RESULT_FILE }}" \
            /d:sonar.pullrequest.key="${{ github.event.pull_request.number }}" \
            /d:sonar.pullrequest.branch="${{ github.head_ref }}" \
            /d:sonar.pullrequest.base="${{ github.base_ref }}"

      - name: Build (required by Sonar)
        run: dotnet build --configuration Release

      - name: SonarCloud End
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end
