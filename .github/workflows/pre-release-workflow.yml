name: .NET Pre-Release

on:
  push:
    branches:
      - 'feature/*'
      - 'hotfix/*'
      - 'develop'

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  NUGET_FEED: https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
  NUGET_KEY: ${{ secrets.GITHUB_TOKEN }}

jobs:
  deploy-pre-release:
    name: Build, Pack & Push Pre-Release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          source-url: ${{ env.NUGET_FEED }}
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine Version Suffix
        id: versioning
        shell: bash
        run: |
          BRANCH_NAME=$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//-/g' )
          BUILD_NUMBER=${{ github.run_number }}

          if [[ $BRANCH_NAME == feature-* ]]; then
            SUFFIX="preview-$BUILD_NUMBER"
          elif [[ $BRANCH_NAME == hotfix-* ]]; then
            SUFFIX="rc-$BUILD_NUMBER"
          elif [[ $BRANCH_NAME == "develop" ]]; then
            SUFFIX="alpha-$BUILD_NUMBER"
          else
            SUFFIX="pre-$BUILD_NUMBER"
          fi

          echo "suffix=$SUFFIX" >> $GITHUB_OUTPUT
          echo "Calculated Suffix: $SUFFIX"

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Extract Base Version
        id: get_version
        shell: bash
        run: |
          # Procura o primeiro arquivo .csproj e extrai a <Version> ou <VersionPrefix>
          PROJECT_FILE=$(find . -name "*.csproj" | head -n 1)
          VERSION=$(grep -oPm1 '(?<=<Version>)[^<]+' "$PROJECT_FILE" || grep -oPm1 '(?<=<VersionPrefix>)[^<]+' "$PROJECT_FILE" || echo "1.0.0")
          echo "base_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Base Version: $VERSION"

      - name: Pack
        run: |
          dotnet pack --configuration Release --no-build \
            --include-symbols \
            -p:PackageVersion="${{ steps.get_version.outputs.base_version }}-${{ steps.versioning.outputs.suffix }}" \
            --output ./artifacts

      - name: Push to GitHub Packages
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --api-key ${{ env.NUGET_KEY }} \
            --source ${{ env.NUGET_FEED }} \
            --skip-duplicate
